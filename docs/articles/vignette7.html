<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phylogenetic random effects • gllvm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Phylogenetic random effects">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gllvm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette1.html">Analysing multivariate abundance data using gllvm</a>
    </li>
    <li>
      <a href="../articles/vignette2.html">Analysing high-dimensional microbial community data using gllvm</a>
    </li>
    <li>
      <a href="../articles/vignette3.html">Introduction to gllvm Part 1: Ordination</a>
    </li>
    <li>
      <a href="../articles/vignette4.html">Introduction to gllvm Part 2: Species correlations</a>
    </li>
    <li>
      <a href="../articles/vignette5.html">How to use the quadratic response model</a>
    </li>
    <li>
      <a href="../articles/vignette6.html">Ordination with predictors</a>
    </li>
    <li>
      <a href="../articles/vignette7.html">Phylogenetic random effects</a>
    </li>
    <li>
      <a href="../articles/vignette8.html">Analysing sparse ecological percent cover data using gllvm</a>
    </li>
    <li>
      <a href="../articles/vignette9.html">Correlation structures for latent variables and row effects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JenniNiku/gllvm/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Phylogenetic random effects</h1>
                        <h4 data-toc-skip class="author">Bert van der
Veen</h4>
            
            <h4 data-toc-skip class="date">2024-10-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/JenniNiku/gllvm/blob/HEAD/vignettes/vignette7.Rmd" class="external-link"><code>vignettes/vignette7.Rmd</code></a></small>
      <div class="hidden name"><code>vignette7.Rmd</code></div>

    </div>

    
    
<p>This vignette is divided into two parts, the first part related to
models with environment covariates only, and the second part for models
that additionally incorporate trait covariates, so called “fourth
corner” models. This is for convenience, as the interface for fitting
fourth corner models slightly differs from the models without traits.
Both models are detailed in <span class="citation">van der Veen and
O’Hara (2024)</span>, and the fourth corner model in more detail in
<span class="citation">Niku et al. (2021)</span>.</p>
<p><strong>For more information about fitting trait models with random
effects, see also vignette 1.</strong></p>
<div class="section level2">
<h2 id="phylogenetically-structured-environmental-responses">Phylogenetically structured environmental responses<a class="anchor" aria-label="anchor" href="#phylogenetically-structured-environmental-responses"></a>
</h2>
<p>In this vignette we demonstrate how to fit models that incorporate
phylogenetic information into the random effects. For this, we make use
of an adjusted version of the familiar lme4-formula interface <span class="citation">Douglas Bates et al. (2024)</span>.</p>
<p>Here, we will use the data by <span class="citation">Abrego et al.
(2015)</span>. It includes information of 215 fungal species at 1666
<em>European beech</em> logs, and was analyzed by the original authors
using a similar model. We start by loading the data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jenniniku.github.io/gllvm/" class="external-link">gllvm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">fungi</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">Y</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">tree</span> <span class="co"># the tree</span></span>
<span><span class="va">colMat</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">C</span> <span class="co"># e.g., from ape::vcv(tree)</span></span>
<span><span class="va">dist</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">dist</span> <span class="co"># e.g., from ape::cophenetic.phylo(tree)</span></span>
<span></span>
<span><span class="co"># Scale the predictors</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DBH.CM"</span>,<span class="st">"AVERDP"</span>,<span class="st">"CONNECT10"</span>,<span class="st">"TEMPR"</span>,<span class="st">"PRECIP"</span>,<span class="st">"log.AREA"</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">[</span>,<span class="va">covs</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="va">covs</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The included version of the package does not contain all available
environmental covariates, only those used in the original analysis. This
includes diameter at breast height (DBH.CM), decay stage (AVERDP),
connectivity of the surrounding forest (CONNECT10), annual temperature
range, annual precipitation, and the logarithm of the reserve’s
area.</p>
<p>We can think of the model as having two covariance matrices: one with
correlation between covariate effects, and another that incorporates the
correlation between species due to the phylogeny. The former is
specified via the formula interface, the form of the latter is (more or
less) fixed at present.</p>
<div class="section level3">
<h3 id="species-ordering">Species ordering<a class="anchor" aria-label="anchor" href="#species-ordering"></a>
</h3>
<p>It is important to note that the error of the NNGP approximation that
is used for fitting the models depends somewhat on the order of the
species in the data <span class="citation">(Guinness 2018)</span>. The
software can minimize the number of VA parameters necessary by utilizing
block structure in the phylogeny (i.e., full independence due to top
splits), so the ideal ordering is often that provided by the tip labels
in the phylogeny (<strong>so make sure not to arbitrarily order the
response data</strong>). The VA method in the gllvm package retains
block structure of the phylogenetic covariance matrix. This is not
necessarily optimal in terms of approximation error of the NNGP.</p>
<p>A less than ideal ordering requires a larger number of nearest
neighbours for an accurate approximation. For cases when the ordering in
from the phylogenetic tree seems to function poorly, we provide a
function (note, not exported) in the package to help evaluate the error
due to a certain species ordering <code>findOrder()</code>. This
calculates the Frobenius norm of the product of the sparse approximation
to the inverse of the phylogenetic covariance matrix and the
phylogenetic covariance matrix, minus the identity matrix, given a
species order and number of nearest neighbours. It returns the error,
the approximation, and the ordering (which retains the block structure
if <code>withinBlock = TRUE</code>, the default). In short: a lower
error means a better approximation (but note the trade-off). Here is
some code to demonstrate this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># order of species in phylogeny tips</span></span>
<span><span class="co"># with a plot of error vs. nearest neighbours</span></span>
<span><span class="va">err1</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">approx1</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span><span class="va">err1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err1</span>, <span class="va">approx1</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err1</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,type<span class="op">=</span><span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Neighbours"</span>, ylab <span class="op">=</span> <span class="st">"Approximation error"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">10</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">15</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># order species alphabetically</span></span>
<span><span class="va">err2</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">approx2</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">err2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err2</span>, <span class="va">approx2</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err2</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># order species by sum of distances</span></span>
<span><span class="va">order</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">err3</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">approx3</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">order</span><span class="op">)</span></span>
<span><span class="va">err3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err3</span>, <span class="va">approx3</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err3</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"forestgreen"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># order species by distance to the root</span></span>
<span><span class="va">allDists</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/cophenetic.phylo.html" class="external-link">dist.nodes</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span>
<span><span class="va">err4</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">approx4</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">allDists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">allDists</span><span class="op">)</span><span class="op">]</span>,decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">err4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err4</span>, <span class="va">approx4</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err4</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"pink"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># order by internal order of edges</span></span>
<span><span class="co"># order &lt;- ape::reorder.phylo(tree, order = "postorder", index.only=TRUE)</span></span>
<span><span class="co"># err5 &lt;- NULL</span></span>
<span><span class="co"># for(i in 1:215){</span></span>
<span><span class="co"># approx5 &lt;- gllvm:::findOrder(covMat = colMat, distMat = dist, nn = i, order = order[order&lt;=length(tree$tip.label)])</span></span>
<span><span class="co"># err5 &lt;- c(err5, approx5$err)</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># lines(y=err5,x=1:215,col="purple")</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># order &lt;- ape::reorder.phylo(tree, order = "pruningwise", index.only=TRUE)</span></span>
<span><span class="co"># err6 &lt;- NULL</span></span>
<span><span class="co"># for(i in 1:215){</span></span>
<span><span class="co"># approx6 &lt;- gllvm:::findOrder(covMat = colMat, distMat = dist, nn = i, order = order[order&lt;=length(tree$tip.label)])</span></span>
<span><span class="co"># err6 &lt;- c(err6, approx6$err)</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># lines(y=err6,x=1:215,col="grey")</span></span>
<span></span>
<span><span class="co"># by first eigenvector</span></span>
<span><span class="va">err7</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">order</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">)</span><span class="op">$</span><span class="va">vec</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">approx7</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">order</span><span class="op">)</span></span>
<span><span class="va">err7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err7</span>, <span class="va">approx7</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err7</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"green"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># squared covariances</span></span>
<span><span class="va">order</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,<span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">colMat</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, colMat <span class="op">=</span> <span class="va">colMat</span><span class="op">)</span>,decreasing<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">err8</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">approx8</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">order</span><span class="op">)</span></span>
<span>    <span class="va">err8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err8</span>, <span class="va">approx8</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err8</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"brown"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># order by the distance of the n nearest neighbours</span></span>
<span><span class="va">err9</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">order</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,<span class="kw">function</span><span class="op">(</span><span class="va">j</span>,<span class="va">dist</span>,<span class="va">nn</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dist</span><span class="op">[</span><span class="va">j</span>,<span class="op">-</span><span class="va">j</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">dist</span><span class="op">[</span><span class="va">j</span>,<span class="op">-</span><span class="va">j</span><span class="op">]</span>,decreasing<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nn</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,nn<span class="op">=</span><span class="va">i</span>,dist<span class="op">=</span><span class="va">dist</span><span class="op">)</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">approx9</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">order</span><span class="op">)</span></span>
<span>    <span class="va">err9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err9</span>, <span class="va">approx9</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">err9</span>,x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># minium sum to preceding species</span></span>
<span><span class="co">#get colMat blocks first</span></span>
<span><span class="va">p</span><span class="op">=</span><span class="fl">215</span></span>
<span><span class="va">blocks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">B</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">E</span> <span class="op">=</span> <span class="va">B</span></span>
<span>  <span class="kw">while</span><span class="op">(</span><span class="va">B</span><span class="op">&lt;=</span><span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">while</span><span class="op">(</span><span class="va">E</span><span class="op">&lt;</span><span class="va">p</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="op">(</span><span class="va">E</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">p</span>,<span class="va">B</span><span class="op">:</span><span class="va">E</span><span class="op">]</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">|</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="va">B</span><span class="op">:</span><span class="va">E</span>,<span class="op">(</span><span class="va">E</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">p</span><span class="op">]</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># expand block</span></span>
<span>      <span class="va">E</span> <span class="op">=</span> <span class="va">E</span><span class="op">+</span><span class="fl">1</span>;</span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># save block</span></span>
<span>    <span class="va">blocks</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">colMat</span><span class="op">[</span><span class="va">B</span><span class="op">:</span><span class="va">E</span>,<span class="va">B</span><span class="op">:</span><span class="va">E</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="va">E</span> <span class="op">=</span> <span class="va">E</span><span class="op">+</span><span class="fl">1</span>;</span>
<span>    <span class="va">B</span> <span class="op">=</span> <span class="va">E</span>;</span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">err10</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ord</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">blocksp</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">ordnew</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span>,<span class="fl">2</span>,<span class="va">max</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="va">idx</span><span class="op">!=</span><span class="va">ordnew</span><span class="op">]</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#add entry of next species with min(i,nn) largest neighbour entries</span></span>
<span>  <span class="va">spec</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">idx</span>,<span class="kw">function</span><span class="op">(</span><span class="va">j</span>,<span class="va">nn</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">ordnew</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># x &lt;- x[x!=0]</span></span>
<span>    <span class="co"># sum(x[order(x,decreasing=TRUE)[1:min(i,nn)]])</span></span>
<span>  <span class="op">}</span>, nn <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">ordnew</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ordnew</span>,<span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="va">idx</span><span class="op">!=</span><span class="va">spec</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span>    <span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ord</span>, <span class="va">ordnew</span><span class="op">+</span><span class="va">blocksp</span><span class="op">)</span></span>
<span>    <span class="va">blocksp</span> <span class="op">&lt;-</span> <span class="va">blocksp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">approx10</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">ord</span><span class="op">)</span></span>
<span><span class="va">err10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err10</span>, <span class="va">approx10</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,<span class="va">err10</span>, col<span class="op">=</span><span class="st">"purple"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># species with minimum of maximum distance to preceding species</span></span>
<span><span class="co"># similar to algorithm maxmin from guiness2018?</span></span>
<span><span class="va">p</span><span class="op">=</span><span class="fl">215</span></span>
<span><span class="va">blocks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">B</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">E</span> <span class="op">=</span> <span class="va">B</span></span>
<span>  <span class="kw">while</span><span class="op">(</span><span class="va">B</span><span class="op">&lt;=</span><span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">while</span><span class="op">(</span><span class="va">E</span><span class="op">&lt;</span><span class="va">p</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="op">(</span><span class="va">E</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">p</span>,<span class="va">B</span><span class="op">:</span><span class="va">E</span><span class="op">]</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">|</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="va">B</span><span class="op">:</span><span class="va">E</span>,<span class="op">(</span><span class="va">E</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">p</span><span class="op">]</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># expand block</span></span>
<span>      <span class="va">E</span> <span class="op">=</span> <span class="va">E</span><span class="op">+</span><span class="fl">1</span>;</span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># save block</span></span>
<span>    <span class="va">blocks</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">colMat</span><span class="op">[</span><span class="va">B</span><span class="op">:</span><span class="va">E</span>,<span class="va">B</span><span class="op">:</span><span class="va">E</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="va">E</span> <span class="op">=</span> <span class="va">E</span><span class="op">+</span><span class="fl">1</span>;</span>
<span>    <span class="va">B</span> <span class="op">=</span> <span class="va">E</span>;</span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">err11</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">215</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ord</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">blocksp</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">ordnew</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span>,<span class="fl">2</span>,<span class="va">max</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="va">idx</span><span class="op">!=</span><span class="va">ordnew</span><span class="op">]</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#add entry of next species with min(i,nn) largest neighbour entries</span></span>
<span>  <span class="va">spec</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">idx</span>,<span class="kw">function</span><span class="op">(</span><span class="va">j</span>,<span class="va">nn</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">ordnew</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># x &lt;- x[x!=0]</span></span>
<span>    <span class="co"># sum(x[order(x,decreasing=TRUE)[1:min(i,nn)]])</span></span>
<span>  <span class="op">}</span>, nn <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">ordnew</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ordnew</span>,<span class="va">spec</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[</span><span class="va">idx</span><span class="op">!=</span><span class="va">spec</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span>    <span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ord</span>, <span class="va">ordnew</span><span class="op">+</span><span class="va">blocksp</span><span class="op">)</span></span>
<span>    <span class="va">blocksp</span> <span class="op">&lt;-</span> <span class="va">blocksp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">approx11</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="va">i</span>, order <span class="op">=</span> <span class="va">ord</span><span class="op">)</span></span>
<span><span class="va">err11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">err11</span>, <span class="va">approx11</span><span class="op">$</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">215</span>,<span class="va">err11</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tips"</span>,<span class="st">"Alphabetical"</span>, <span class="st">"Total distance"</span>, <span class="st">"Distance to root"</span>, <span class="st">"First eigenvector"</span>,<span class="st">"Sum of squared covariances"</span>,<span class="st">"Total distance (nn)"</span>, <span class="st">"minsum"</span>, <span class="st">"maxmin"</span><span class="op">)</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"blue"</span>, <span class="st">"forestgreen"</span>,<span class="st">"pink"</span>, <span class="st">"green"</span>, <span class="st">"brown"</span>,<span class="st">"orange"</span>,<span class="st">"purple"</span>,<span class="st">"grey"</span><span class="op">)</span>,lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"solid"</span>,<span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="specord-1.png" alt="plot of chunk specord"><p class="caption">
plot of chunk specord
</p>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#low number of neighbours: 3 is best.</span></span>
<span><span class="co">#plot(y=apply(cbind(err1,err2,err3,err4,err7,err8,err9,err10,err11),1,which.min),x=1:215)</span></span></code></pre></div>
<p>The red lines indicate 10, 15, and 20 neighbours. Clearly, ordering
the species by the sum of distances, sum of squared covariances, or by
the first eigenvector of the phylogenetic covariance matrix, give good
approximations (i.e., most accurate with least neighbours) for this
dataset.</p>
<!-- # The function has a "withinBlock" argument -->
<!-- # to find if we can find a better ordering while retaining the block diagonal structure -->
<!-- # try some random permutations within block -->
<!-- errold <- Inf -->
<!-- order1 <- NULL -->
<!-- for(i in 1:10){ -->
<!-- order <- sample(size=215, x=1:215) -->
<!-- approx<-findOrder(covMat = colMat, distMat = dist, -->
<!--           order = order, withinBlock = TRUE) -->
<!-- errnew<-approx$err -->
<!-- if(is.null(order1)|errnew<err){ -->
<!--   order1<-order -->
<!--   err <- errnew -->
<!-- } -->
<!-- } -->
<!-- err -->
<p>This serves to demonstrate that the species order does matter to the
approximation, and a better order may be available. In the plot we can
see that the error reduces quickly towards 10-15 neighbours, and levels
out after about 50 neighbours. If we plotted the same curve wit the
computation time, it would probably exhibit the opposite of the
displayed pattern.</p>
</div>
<div class="section level3">
<h3 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">TMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/TMB/man/openmp.html" class="external-link">openmp</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, autopar <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># set parallel computation</span></span>
<span><span class="va">order</span> <span class="op">&lt;-</span> <span class="fu">gllvm</span><span class="fu">:::</span><span class="fu">findOrder</span><span class="op">(</span>covMat <span class="op">=</span> <span class="va">colMat</span>, distMat <span class="op">=</span> <span class="va">dist</span>, nn <span class="op">=</span> <span class="fl">15</span>,</span>
<span>          order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">allDists</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">allDists</span><span class="op">)</span><span class="op">]</span>,decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">order</span></span>
<span><span class="va">order</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span><span class="op">[</span><span class="va">order</span><span class="op">]</span></span>
<span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gllvm.html">gllvm</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>,<span class="va">order</span><span class="op">]</span>, X <span class="op">=</span> <span class="va">X</span>,</span>
<span>        formula <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="va">DBH.CM</span> <span class="op">+</span> <span class="va">AVERDP</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">AVERDP</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">CONNECT10</span> <span class="op">+</span> <span class="va">TEMPR</span> <span class="op">+</span> <span class="va">PRECIP</span> <span class="op">+</span> <span class="va">log.AREA</span><span class="op">|</span><span class="fl">1</span><span class="op">)</span>, beta0com <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     family <span class="op">=</span> <span class="st">"binomial"</span>, num.lv <span class="op">=</span> <span class="fl">0</span>, sd.errors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     studyDesign <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"REGION"</span>, <span class="st">"RESERVE"</span><span class="op">)</span><span class="op">]</span>, row.eff <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">REGION</span><span class="op">/</span><span class="va">RESERVE</span><span class="op">)</span>,</span>
<span>                     colMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">colMat</span><span class="op">[</span><span class="va">order</span>,<span class="va">order</span><span class="op">]</span>, dist <span class="op">=</span> <span class="va">dist</span><span class="op">[</span><span class="va">order</span>,<span class="va">order</span><span class="op">]</span><span class="op">)</span>, colMat.rho.struct <span class="op">=</span> <span class="st">"term"</span>, nn.colMat <span class="op">=</span> <span class="fl">15</span>,</span>
<span>        optim.method <span class="op">=</span> <span class="st">"L-BFGS-B"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s walk through some of the specified arguments.</p>
<p>The first line enables parallel computation, to speed up model
fitting.</p>
<p>Note that an intercept term is included in the random effects, which
can be excluded by incorporating a zero in the formula term.
Correlations are included between covariates inside the brackets, so we
could have uncorrelated effects by including them all in separately
bracketed terms. We specify <code>num.lv = 0</code> for now, although we
could just as well include latent variables (e.g., we could fit a model
with phylogenetically structured random intercepts and a (un)constrained
ordination), and <code>beta0comm</code> to have a single (fixed)
intercept for the whole community (species-specific intercepts enter via
the random effects). <code>sd.errors</code> is here for convenience set
to false, as it can take a (much) longer time to calculate standard
errors than to fit the model, and we should really only calculate the
standard errors when we need them (e.g., for visualization). The
<code><a href="../reference/se.gllvm.html">gllvm::se.gllvm</a></code> function can post-hoc calculate the
standard errors, so that we do not need to refit the model.</p>
<p>The <code>studyDesign</code> matrix is specified to additionally
incorporated random intercepts for the nested study design. and a
formula <code>row.eff</code> to specify the random intercept structure.
The <code>colMat</code> term is how we pass the phylogenetic information
to the model, which is usually a list of length two, where one argument
is called <code>dist</code> and the other is the covariance matrix from
the tree. Note that these two matrices need to have the same column
names as <code>Y</code>. <code>nn.colMat</code> is the number of nearest
neighbours to consider for each species on the tree, which is fixed to
10 by default. Smaller numbers usually result in a faster fitting model,
but one that is potentially less accurate. <span class="citation">van
der Veen and O’Hara (2024)</span> showed that 10-15 neighbours is
usually a good choice, although fewer/more also still lead to accurate
estimates for the phylogenetic signal, but this can be quite problem
dependent. <code>colMat.rho.struct</code> has two options,
<code>single</code> fitting a model with the same phylogenetic signal
parameter for all covariates (default) and <code>term</code> fitting a
model with a phylogenetic signal parameter per covariate. Finally, the
last line changes the optimisation method to one that seems to usually
do well with this model type, and changes the starting values of the
random effect (which was needed to fit this model succesfully).</p>
<p>After model fitting, the random effect estimates can be found in
<code>model1$params$Br</code>, and prediction errors can be extracted
with <code><a href="../reference/getPredictErr.gllvm.html">gllvm::getPredictErr</a></code>. This requires the standard
errors, so let’s calculate thosefirst:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate standard errors</span></span>
<span><span class="va">ses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/se.gllvm.html">se.gllvm</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span> <span class="co"># this can take a few minutes</span></span>
<span><span class="va">model1</span><span class="op">$</span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="va">ses</span><span class="op">$</span><span class="va">sd</span></span>
<span><span class="va">model1</span><span class="op">$</span><span class="va">Hess</span> <span class="op">&lt;-</span> <span class="va">ses</span><span class="op">$</span><span class="va">Hess</span></span></code></pre></div>
<p>Here is some code to visualize the model results (from <span class="citation">van der Veen and O’Hara (2024)</span>):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Making the term namees a bit prettier</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">model1</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">Br</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"Deadwood size"</span>, <span class="st">"Decay stage"</span>, <span class="st">"Decay stage²"</span>, <span class="st">"Connectivity"</span>, <span class="st">"Temperature range"</span>, <span class="st">"Precipitation"</span>,<span class="st">"ln(Reserve area)"</span><span class="op">)</span></span>
<span><span class="va">model1</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">B</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model1</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">B</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">model1</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">Br</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">model1</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">Br</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/phyloplot.gllvm.html">phyloplot</a></span><span class="op">(</span><span class="va">model1</span>, <span class="va">tree</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="bigplot-1.png" alt="plot of chunk bigplot"><p class="caption">
plot of chunk bigplot
</p>
</div>
<p>The random effects with a prediction interval including zero are
crossed out in the plot. The <code>getResidualCov</code> and
<code>getResidualCor</code> functions extract the residual covariance
and correlation matrix, respectively, for visualizing species
associations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span><span class="fu"><a href="../reference/getEnvironCov.gllvm.html">getEnvironCor</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span>,</span>
<span>                   type <span class="op">=</span> <span class="st">"lower"</span>, diag <span class="op">=</span> <span class="cn">FALSE</span>, order <span class="op">=</span> <span class="st">"AOE"</span>,</span>
<span>                   tl.pos <span class="op">=</span> <span class="st">"n"</span>, addgrid.col<span class="op">=</span><span class="cn">NA</span>, col.lim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="corrplot-1.png" alt="plot of chunk corrplot"><p class="caption">
plot of chunk corrplot
</p>
</div>
<p>The <code>randomCoefPlot</code> function constructs caterpillar plots
of species deviations from the community mean responses, which can be
extracted via the summary method, or found via <code>coef</code> and in
<code>model1$params$B</code>.</p>
<p>Arguments to control the VA approximation are <code>Ab.struct</code>
and <code>Ab.struct.rank</code>, for details see <span class="citation">van der Veen and O’Hara (2024)</span>. NOTE: Use
<code>Ab.struct = "CL1"</code> or <code>Ab.struct="CL2"</code> only in
parallel when using <code>TMB::openmp(.., autopar=TRUE)</code>. Without
TMB’s “automatic” parallelization feature, memory use is excessively and
your computer will probably run out of memory (for a moderately large
number of sites and species) so that your R session will crash.</p>
<!--(but, note that changing both of these options will likely cause a significant increase in memory use when combined with parallel computation).-->
<p>Finally, we can look at the summary information of the model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##</span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## gllvm(y = Y[, order], X = X, formula = ~(DBH.CM + AVERDP + I(AVERDP^2) +</span></span>
<span><span class="co">##     CONNECT10 + TEMPR + PRECIP + log.AREA | 1), family = "binomial",</span></span>
<span><span class="co">##     num.lv = 0, studyDesign = X[, c("REGION", "RESERVE")], colMat = list(colMat[order,</span></span>
<span><span class="co">##         order], dist = dist[order, order]), colMat.rho.struct = "term",</span></span>
<span><span class="co">##     row.eff = ~(1 | REGION/RESERVE), sd.errors = FALSE, beta0com = TRUE,</span></span>
<span><span class="co">##     nn.colMat = 15, optim.method = "L-BFGS-B")</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Family:  binomial</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## AIC:  103080 AICc:  103080 BIC:  103662.6 LL:  -51486 df:  54</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Informed LVs:  0</span></span>
<span><span class="co">## Constrained LVs:  0</span></span>
<span><span class="co">## Unconstrained LVs:  0</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Formula:  ~(DBH.CM + AVERDP + I(AVERDP^2) + CONNECT10 + TEMPR + PRECIP + log.AREA | 1)</span></span>
<span><span class="co">## LV formula:  ~ 0</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Name        Signal Variance Std.Dev Corr</span></span>
<span><span class="co">##  Intercept   0.2106 0.5218   0.7224</span></span>
<span><span class="co">##  DBH.CM      0.5031 0.0052   0.0722   0.7524</span></span>
<span><span class="co">##  AVERDP      0.9711 0.3825   0.6185   0.1015 -0.0181</span></span>
<span><span class="co">##  I.AVERDP.2. 0.8007 0.0122   0.1105  -0.4874 -0.4696 -0.4871</span></span>
<span><span class="co">##  CONNECT10   0.0613 0.0270   0.1642  -0.1800 -0.1082  0.1563 -0.1128</span></span>
<span><span class="co">##  TEMPR       0.0499 0.0436   0.2087  -0.1579 -0.2858 -0.0683  0.7212  0.3666</span></span>
<span><span class="co">##  PRECIP      0.0000 0.0324   0.1799   0.2290  0.6520 -0.3145  0.0977 -0.5629</span></span>
<span><span class="co">##  log.AREA    0.0310 0.0158   0.1258  -0.1418 -0.1302  0.0928 -0.6283  0.4803</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##</span></span>
<span><span class="co">##  -0.2123</span></span>
<span><span class="co">##  -0.5604 -0.5228</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Coefficients predictors:</span></span>
<span><span class="co">##             Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span><span class="co">## Intercept   -2.05756    0.13590 -15.140  &lt; 2e-16 ***</span></span>
<span><span class="co">## DBH.CM       0.10583    0.01936   5.465 4.62e-08 ***</span></span>
<span><span class="co">## AVERDP      -0.08548    0.22763  -0.376 0.707278</span></span>
<span><span class="co">## I.AVERDP.2. -0.12467    0.03344  -3.728 0.000193 ***</span></span>
<span><span class="co">## CONNECT10   -0.03260    0.04141  -0.787 0.431209</span></span>
<span><span class="co">## TEMPR        0.03646    0.04454   0.818 0.413120</span></span>
<span><span class="co">## PRECIP      -0.02091    0.03726  -0.561 0.574756</span></span>
<span><span class="co">## log.AREA     0.05643    0.02976   1.896 0.057952 .</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p>which gives us an overview of the community mean responses, as well
as the variance and correlation of random effects, and the phylogenetic
signal parameter in the column <code>signal</code>. This parameter
ranges between zero and one, at zero the species responses are not
phylogenetically structured, and at one they are fully phylogenetically
structured.</p>
<!-- The `confint` function returns (approximate asysmptotic) confidence intervals for all parameters, including the phylogenetic signal. We might instead want to use TMB's functionality for calculating a profile confidence interval instead (since it will be more accurate and appropriate, though it tends to take quite a lot of time) for the phylogenetic signal parameters: -->
<!-- ```{r, cache = TRUE, message=FALSE, warning=FALSE, echo = -6, eval = FALSE} -->
<!-- profs <- list() -->
<!-- # This may take a few minutes -->
<!-- for(i in 1:ncol(model1$col.eff$spdr)){ -->
<!--   profs[[i]] <- TMB::tmbprofile(model1$TMBfn, name = tail(which(names(model1$TMBfn$par)=="sigmaB"), ncol(model1$col.eff$spdr))[i], h = 1, parm.range = c(-12,3.5)) -->
<!-- } -->
<!-- ``` -->
<!-- ```{r, echo = FALSE} -->
<!-- load("model1profs.RData") -->
<!-- library(TMB) -->
<!-- ``` -->
<!-- ```{r, warning=FALSE, error=FALSE} -->
<!-- for(i in 1:length(profs)){ -->
<!--   profs[[i]][,1] <- exp(-exp(profs[[i]][,1])) -->
<!--   plot(profs[[i]][!apply(profs[[i]],1,anyNA),]) -->
<!-- } -->
<!-- ``` -->
</div>
</div>
<div class="section level2">
<h2 id="phylogenetic-fourth-corner-model">Phylogenetic fourth corner model<a class="anchor" aria-label="anchor" href="#phylogenetic-fourth-corner-model"></a>
</h2>
<p>The fourth corner model extends the previous model with functional
traits. The interface is still a little difference, so that correlation
between random effects are always included. Otherwise the tools are
similar, so we just present some example code here for fitting such a
model, but do not discuss it further (see other vignettes in the gllvm
R-package for discussion of the fourth corner model).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">$</span><span class="va">TR</span> <span class="co"># the functional traits</span></span>
<span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gllvm.html">gllvm</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>int <span class="op">=</span> <span class="fl">1</span>, <span class="va">X</span><span class="op">)</span>, TR <span class="op">=</span> <span class="va">TR</span>,</span>
<span>                     formula <span class="op">=</span> <span class="op">~</span><span class="va">DBH.CM</span> <span class="op">+</span> <span class="va">AVERDP</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">AVERDP</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">CONNECT10</span> <span class="op">+</span></span>
<span>  <span class="va">TEMPR</span> <span class="op">+</span> <span class="va">PRECIP</span> <span class="op">+</span> <span class="va">log.AREA</span> <span class="op">+</span> <span class="op">(</span><span class="va">DBH.CM</span> <span class="op">+</span> <span class="va">AVERDP</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">AVERDP</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">CONNECT10</span> <span class="op">+</span> <span class="va">TEMPR</span> <span class="op">+</span> <span class="va">PRECIP</span> <span class="op">+</span> <span class="va">log.AREA</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">PC1.1</span> <span class="op">+</span> <span class="va">PC1.2</span> <span class="op">+</span> <span class="va">PC1.3</span><span class="op">)</span>,</span>
<span>                      family <span class="op">=</span> <span class="st">"binomial"</span>, num.lv <span class="op">=</span> <span class="fl">0</span>, studyDesign <span class="op">=</span> <span class="va">X</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"REGION"</span>, <span class="st">"RESERVE"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                      colMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">C</span>, dist <span class="op">=</span> <span class="va">dist</span><span class="op">)</span>,</span>
<span>                      colMat.rho.struct <span class="op">=</span> <span class="st">"term"</span>, row.eff <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">REGION</span><span class="op">/</span><span class="va">RESERVE</span><span class="op">)</span>, sd.errors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                      randomX <span class="op">=</span> <span class="op">~</span><span class="va">int</span> <span class="op">+</span> <span class="va">DBH.CM</span> <span class="op">+</span> <span class="va">AVERDP</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">AVERDP</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">CONNECT10</span> <span class="op">+</span> <span class="va">TEMPR</span> <span class="op">+</span> <span class="va">PRECIP</span> <span class="op">+</span> <span class="va">log.AREA</span>,</span>
<span>                      beta0com <span class="op">=</span> <span class="cn">TRUE</span>, Ab.struct <span class="op">=</span> <span class="st">"MNunstructured"</span>, nn.colMat <span class="op">=</span> <span class="fl">10</span>, max.iter <span class="op">=</span> <span class="fl">20000</span>, maxit <span class="op">=</span> <span class="fl">20000</span>, optim.method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>randomX.start <span class="op">=</span> <span class="st">"res"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Abrego2022a" class="csl-entry">
Abrego, N., C. Bässler, M. Christensen, and J. Heilmann-Clausen. 2015.
<span>“Data and Code from: Traits and Phylogenies Module the
Environmental Responses of Wood-Inhabiting Fungal Communities Across
Spatial Scales.”</span> Dryad. https://doi.org/<a href="https://doi.org/10.5061/dryad.t76hdr82r" class="external-link">https://doi.org/10.5061/dryad.t76hdr82r</a>.
</div>
<div id="ref-lme4" class="csl-entry">
Bates, D., M. Mächler, B. Bolker, and S. Walker. 2015. <span>“Fitting
Linear Mixed-Effects Models Using Lme4”</span> 67: 1–48.
</div>
<div id="ref-lme4_software" class="csl-entry">
Bates, Douglas, Martin Maechler, Ben Bolker, Steven Walker, Rune Haubo
Bojesen Christensen, Henrik Singmann, Bin Dai, et al. 2024. <span>“Lme4:
Linear Mixed-Effects Models Using <span>‘Eigen’</span> and S4.”</span>
CRAN. <a href="https://CRAN.R-project.org/package=lme4" class="external-link">https://CRAN.R-project.org/package=lme4</a>.
</div>
<div id="ref-Guinness2018" class="csl-entry">
Guinness, J. 2018. <span>“Permutation and Grouping Methods for
Sharpening Gaussian Process Approximations”</span> 60: 415–29.
</div>
<div id="ref-Niku2021" class="csl-entry">
Niku, J., F.K.C. Hui, S. Taskinen, and D.I. Warton. 2021.
<span>“Analyzing Environmental-Trait Interactions in Ecological
Communities with Fourth-Corner Latent Variable Models”</span> 32.6:
e2683.
</div>
<div id="ref-vanderVeen2024" class="csl-entry">
Veen, B. van der, and R.B. O’Hara. 2024. <span>“Fast Fitting of
Phylogenetic Mixed Effects Models.”</span> https://doi.org/<a href="https://www.arxiv.org/abs/2408.05333" class="external-link">https://www.arxiv.org/abs/2408.05333</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jenni Niku, Wesley Brooks, Riki Herliansyah, Francis K.C. Hui, Pekka Korhonen, Sara Taskinen, Bert van der Veen, David I. Warton.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
